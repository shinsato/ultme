function setupDB(e){e.executeSql("CREATE TABLE IF NOT EXISTS user (id INTEGER UNIQUE,account_id INTEGER,name TEXT,email TEXT,password TEXT,tile_list TEXT, created NUMERIC, modified NUMERIC,deleted NUMERIC)"),e.executeSql('CREATE TABLE IF NOT EXISTS tile (id INTEGER UNIQUE,user_id INTEGER,account_id INTEGER,name TEXT,type TEXT NOT NULL DEFAULT "tally",status TEXT NOT NULL DEFAULT "active",options TEXT,min INTEGER,max INTEGER,created NUMERIC,modified NUMERIC,archived NUMERIC,deleted NUMERIC)'),e.executeSql("CREATE TABLE IF NOT EXISTS response (id INTEGER UNIQUE,account_id INTEGER,user_id INTEGER,tile_id INTEGER,value INTEGER,geolocation TEXT,created NUMERIC)")}function setupDB(e){e.executeSql("CREATE TABLE IF NOT EXISTS user (id INTEGER UNIQUE,account_id INTEGER,name TEXT,email TEXT,password TEXT,tile_order TEXT, created NUMERIC, modified NUMERIC,deleted NUMERIC)"),e.executeSql('CREATE TABLE IF NOT EXISTS tile (id INTEGER UNIQUE,user_id INTEGER,account_id INTEGER,name TEXT,type TEXT NOT NULL DEFAULT "tally",status TEXT NOT NULL DEFAULT "active",options TEXT,min INTEGER,max INTEGER,created NUMERIC,modified NUMERIC,archived NUMERIC,deleted NUMERIC)'),e.executeSql("CREATE TABLE IF NOT EXISTS response (id INTEGER UNIQUE,account_id INTEGER,user_id INTEGER,tile_id INTEGER,value INTEGER,geolocation TEXT,created NUMERIC)")}function replace(e,t){for(var a in t){var i=new RegExp("{{"+a+"}}","g");e=e.replace(i,t[a])}return e}function updateTileOrder(e){$("#container .item").each(function(e,t){var a=[],i=$(t);""!==i.data("rowid")&&a.push(i.data("rowid"))})}var app={initialize:function(){function e(){app.db.transaction(function(e){e.executeSql('INSERT INTO tile (name,type) VALUES("Did you drink coffee?","binary")')}),app.db.transaction(function(e){e.executeSql('INSERT INTO tile (name,type) VALUES("How many cups?","tally")')}),app.db.transaction(function(e){e.executeSql('INSERT INTO tile (name,type) VALUES("Are you glad you did?","binary")')}),app.db.transaction(function(e){e.executeSql('INSERT INTO tile (name,type) VALUES("How many red lights?","tally")')}),app.db.transaction(function(e){e.executeSql('INSERT INTO tile (name,type,min,max) VALUES("How would you rate today?","scale",-5,5)')})}function t(){app.db.transaction(function(e){e.executeSql("DROP TABLE user")}),app.db.transaction(function(e){e.executeSql("DROP TABLE tile")}),app.db.transaction(function(e){e.executeSql("DROP TABLE response")})}this.bindEvents(),this.initDb()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1),document.addEventListener("documentready",this.onDeviceReady,!1)},onDeviceReady:function(){app.receivedEvent("deviceready"),this.initDb()},receivedEvent:function(e){var t=document.getElementById(e),a=t.querySelector(".listening"),i=t.querySelector(".received");a.setAttribute("style","display:none;"),i.setAttribute("style","display:block;"),window.console.log("Received Event: "+e)},initDb:function(){app.db=window.openDatabase("ultme","1.0","Ultimately Me",1e6),app.db.transaction(setupDB),this.createUserIfNotExists()},createUserIfNotExists:function(){app.db.transaction(function(e){e.executeSql("SELECT *,rowid FROM user",[],function(e,t){var a=t.rows.length;a>0?app.userid=t.rows.item(0).rowid:app.db.transaction(function(e){(new Date).getTime();var t=Date.now();e.executeSql("INSERT INTO user (created) VALUES(?)",[t],function(e,t){app.userid=t.insertId})})})})}},saveTallyResponse=function(e,t){__saveTallyResponse(e,t,null,null)},__saveTallyResponse=function(e,t,a,i){(new Date).getTime();var n=Date.now(),o="";a&&i&&(o=a+","+i),e.db.transaction(function(a){a.executeSql("INSERT INTO response (tile_id,user_id,value,geolocation,created) VALUES (?,?,?,?,?)",[t,e.userid,1,o,n],function(a,i){updateTallyValue(e,t)})})},updateTallyValue=function(e,t){e.db.transaction(function(e){e.executeSql("SELECT sum(value) as total FROM response WHERE tile_id = ?",[t],function(e,a){var i=a.rows.item(0).total;i=i>0?i:0;var n=$("[data-rowid='"+t+"']"),o=$(n.find(".js-display"));o.text(i),n.attr("data-value",i),n.data("value",i)})})},saveBinaryResponse=function(e,t,a){__saveBinaryResponse(e,t,a,null,null)},__saveBinaryResponse=function(e,t,a,i,n){(new Date).getTime();var o=Date.now(),l="";i&&n&&(l=i+","+n),e.db.transaction(function(i){i.executeSql("INSERT INTO response (tile_id,user_id,value,geolocation,created) VALUES (?,?,?,?,?)",[t,e.userid,a,l,o],function(a,i){updateBinaryValue(e,t)})})},updateBinaryValue=function(e,t){e.db.transaction(function(e){e.executeSql("SELECT * FROM response left join tile on response.tile_id = tile.rowid WHERE response.tile_id = ? ORDER BY response.id DESC LIMIT 1",[t],function(e,a){var i=$("[data-rowid='"+t+"']"),n=$(i.find(".js-display"));if(a.rows.length>0){var o=a.rows.item(0).value,l=JSON.parse(a.rows.item(0).options),d="";d=o>0?l["label-b"]:l["label-a"],n.text(d),i.attr("data-value",d),i.data("value",d)}else n.text("0"),i.attr("data-value","0"),i.data("value","0")},function(e,t){console.log(e,t)})})},saveScaleResponse=function(e,t,a){__saveScaleResponse(e,t,a,null,null)},__saveScaleResponse=function(e,t,a,i,n){(new Date).getTime();var o=Date.now(),l="";i&&n&&(l=i+","+n),e.db.transaction(function(i){i.executeSql("INSERT INTO response (tile_id,user_id,value,geolocation,created) VALUES (?,?,?,?,?)",[t,e.userid,a,l,o],function(a,i){updateScaleValue(e,t)})})},updateScaleValue=function(e,t){e.db.transaction(function(e){e.executeSql("SELECT value FROM response WHERE tile_id = ?  ORDER BY id DESC LIMIT 1",[t],function(e,a){var i=$("[data-rowid='"+t+"']"),n=$(i.find(".js-display"));if(a.rows.length>0){var o=a.rows.item(0).value;n.text(o),i.attr("data-value",o),i.data("value",o)}else n.text("0"),i.attr("data-value","0"),i.data("value","0")})})},resetTile=function(e,t){e.db.transaction(function(a){a.executeSql("DELETE FROM response WHERE tile_id = ?",[t],function(t,a){loadTiles(e)})})},deleteTile=function(e,t){e.db.transaction(function(a){a.executeSql("DELETE FROM response WHERE tile_id = ?",[t],function(a,i){a.executeSql("DELETE FROM tile WHERE tile_id = ?",[t],function(t,a){loadTiles(e),updateTileOrder(e)})})})},editTile=function(e,t,a,i,n,o){return!e||1>t?!1:(a=a||"",i=i||"",n=n||"",o=o||"",void e.db.transaction(function(l){l.executeSql("SELECT options FROM tile where rowid = ?",[t],function(l,d){(new Date).getTime();var s=Date.now(),r=JSON.parse(d.rows.item(0).options);r["label-a"]=i,r["label-b"]=n,r.timebox=o,e.db.transaction(function(i){i.executeSql("UPDATE tile SET name = ?, options = ?, modified = ? WHERE rowid = ?",[a,JSON.stringify(r),s,t],function(t,a){loadTiles(e)})})})}))};$(document).on("submit","#form-tile-edit",function(){var e=$(this),t=[];return $.each(e.serializeArray(),function(e,a){t[a.name]=a.value}),editTile(app,t["tile-id"],t["tile-name"],t["label-a"],t["label-b"],t["tile-timebox"]),$("body").toggleClass("overlay-open",function(){$(".overlay").find(".overlay-body").html("")}),!1});var init=function(){var e=$("body"),t=$(".overlay"),a=function(e){e.addClass("flash"),setTimeout(function(){e.removeClass("flash")},100)};$('[data-type="tally"]').each(function(e,t){updateTallyValue(app,$(t).data("rowid"))}),$('[data-type="binary"]').each(function(e,t){updateBinaryValue(app,$(t).data("rowid"))}),$('[data-type="scale"]').each(function(e,t){updateScaleValue(app,$(t).data("rowid"))}),$$(document).on("tap",'[data-type="tally"]',function(){var e=$$(this);saveTallyResponse(app,e.data("rowid")),a(e)}),$$('[data-type="binary"]').swipeRight(function(e){var t=$$(this);saveBinaryResponse(app,t.data("rowid"),1)}),$$('[data-type="binary"]').swipeLeft(function(e){var t=$$(this);saveBinaryResponse(app,t.data("rowid"),0)}),$$('[data-type="scale"]').swiping(function(e){var t=$$(this);t.data("swiping","true");var a=arguments[0].currentTouch.x,i=window.innerWidth,n=i/11;a=a>i?i-1:a,a=0>a?0:a;var o=Math.floor(a/n);o-=5,t.find(".js-display").text(o),t.data("val",o)}),$$('[data-type="scale"]').on("touchend",function(){var e=$$(this);if("true"===e.data("swiping")){e.data("swiping","false");var t=e.data("val"),a=e.data("rowid");saveScaleResponse(app,e.data("rowid"),t)}}),$$(document).on("tap","[toggle-overlay]",function(e){e.stopPropagation();var t=$(this).attr("toggle-overlay"),a=$(this).data("type");$(".overlay").removeClass("binary tally scale new").addClass(a),t.length?($me=$(this).closest(".item"),$.get(t+".html",[],function(e){var t=$me.data("options")?JSON.parse($me.data("options")):{},i={type:a,rowid:$me.data("rowid"),name:$me.data("name"),labela:t["label-a"],labelb:t["label-b"],timeboxtoday:"today"===t.timebox?"checked":"",timeboxweek:"week"===t.timebox?"checked":"",timeboxmonth:"month"===t.timebox?"checked":"",timeboxforever:"forever"===t.timebox?"checked":""};e=replace(e,i),$(".overlay-body").html(e),$("body").toggleClass("overlay-open")})):$("body").toggleClass("overlay-open",function(){$(".overlay-body").html("")})})},loadTiles=function(e){var t=[];e.db.transaction(function(e){e.executeSql("SELECT *,rowid FROM tile",[],function(e,a){for(var i=a.rows.length,n=0;i>n;n++)t.push(a.rows.item(n));$("#container").empty();for(var o in t){var l=t[o].type,d=t[o].rowid,s=t[o].options,r=t[o].name,c=$('<div class="item '+l+'"></div>'),u=$('<div class="tile-actions"></div>');switch(c.attr("data-value",0),c.attr("data-type",l),c.attr("data-rowid",d),c.data("options",s),c.data("name",r),c.data("value",0),c.data("type",l),c.append("<h2>"+r+"</h2>"),l){case"binary":u.append('<div class="report-cue" data-type="binary" toggle-overlay="overlay/tile-log">&#9776;</div>'),u.append('<div class="edit-cue" data-type="binary" toggle-overlay="overlay/edit">⬡</div>'),c.append('<label class="js-display string">---</label>'),c.append(u);break;case"tally":u.append('<div class="report-cue" data-type="tally" toggle-overlay="overlay/tile-log">&#9776;</div>'),u.append('<div class="edit-cue" data-type="tally" toggle-overlay="overlay/edit">⬡</div>'),c.append('<label class="js-display string">---</label>'),c.append(u);break;case"scale":u.append('<div class="report-cue" data-type="scale" toggle-overlay="overlay/tile-log">&#9776;</div>'),u.append('<div class="edit-cue" data-type="scale" toggle-overlay="overlay/edit">⬡</div>'),c.append('<label class="js-display string">---</label>'),c.append(u)}$("#container").append(c)}init()},function(e,t){window.console.log("error",e,t)})})};app.initialize(),loadTiles(app),$(document).on("pagecreate","#pageone",function(){$("div").on("click",function(){})}).on("submit","#update-tile",function(){var e=$(this),t=[];if($.each(e.serializeArray(),function(e,a){t[a.name]=a.value}),t["tile-id"]>0);else{(new Date).getTime();var a=Date.now(),i={"label-a":t["label-a"],"label-b":t["label-b"],timebox:t["tile-timebox"]};app.db.transaction(function(e){e.executeSql("INSERT INTO tile (name,user_id,type,options,created,modified) VALUES(?,?,?,?,?,?)",[t["tile-name"],app.userid,t["tile-type"],JSON.stringify(i),a,a],function(e,t){loadTiles(app),$("body").toggleClass("overlay-open"),updateTileOrder(app)})})}return!1});